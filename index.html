<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<title>Itest - חלוקת תלמידים</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body { font-family: Arial; direction: rtl; padding: 20px; background: #f9f9f9; }
h1 { text-align: center; margin-bottom: 20px; }
h2 { margin-top: 30px; }
table { border-collapse: collapse; width: 100%; margin-top: 10px; }
th, td { border: 1px solid #444; padding: 6px; text-align: center; }
th { background: #eee; }
button { padding: 10px; margin-top: 10px; margin-right: 10px; }
.room-0 { background-color: #ffdede; }  /* עוז */
.room-1 { background-color: #deffde; }  /* סיבם תיבם */
.room-2 { background-color: #dedeff; }  /* Itest */
.room-3 { background-color: #fff5de; }  /* משאבים */
</style>
</head>

<body>

<h1>Itest - חלוקת תלמידים</h1>

<input type="file" id="excelFile" accept=".xlsx,.xls"><br><br>

<label>שעת התחלת הבחינה:</label>
<input type="time" id="startTime" value="09:00"><br><br>

<button onclick="processFile()">בצע שיבוץ</button>
<button onclick="downloadExcel()" id="downloadBtn" style="display:none">
הורדת קובץ Excel
</button>

<div id="result"></div>

<script>
const EXAM_DURATION = 30;
const ROOMS = ["עוז","סיבם תיבם","Itest","משאבים"];
let finalData = [];

function processFile() {
  const fileInput = document.getElementById("excelFile");
  if (!fileInput.files.length) { alert("נא להעלות קובץ Excel"); return; }

  const reader = new FileReader();
  reader.onload = e => {
    const data = new Uint8Array(e.target.result);
    const wb = XLSX.read(data, { type: "array" });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const students = XLSX.utils.sheet_to_json(sheet);
    distribute(students);
  };
  reader.readAsArrayBuffer(fileInput.files[0]);
}

function distribute(students) {
  const startTime = document.getElementById("startTime").value;
  finalData = [];

  students.forEach((s, index) => {
    const roomIndex = index % ROOMS.length;
    const slot = Math.floor(index / ROOMS.length);

    const start = addMinutes(startTime, slot * EXAM_DURATION);
    const end = addMinutes(start, EXAM_DURATION);

    finalData.push({
      "שם תלמיד": s["שם תלמיד"],
      "חדר": ROOMS[roomIndex],
      "שעת התחלה": start,
      "שעת סיום": end,
      "roomClass": "room-" + roomIndex
    });
  });

  showTablesByRoom();
  document.getElementById("downloadBtn").style.display = "inline-block";
}

function addMinutes(time, mins) {
  let [h,m] = time.split(":").map(Number);
  let total = h*60 + m + mins;
  let nh = Math.floor(total/60) % 24;
  let nm = total % 60;
  return `${String(nh).padStart(2,"0")}:${String(nm).padStart(2,"0")}`;
}

function showTablesByRoom() {
  let html = "";
  ROOMS.forEach((room, idx) => {
    html += `<h2>${room}</h2>`;
    html += `<table><tr><th>שם תלמיד</th><th>שעת התחלה</th><th>שעת סיום</th></tr>`;
    finalData.filter(r => r["חדר"] === room).forEach(r => {
      html += `<tr class="room-${idx}">
        <td>${r["שם תלמיד"]}</td>
        <td>${r["שעת התחלה"]}</td>
        <td>${r["שעת סיום"]}</td>
      </tr>`;
    });
    html += `</table>`;
  });
  document.getElementById("result").innerHTML = html;
}

function downloadExcel() {
  const ws = XLSX.utils.json_to_sheet(finalData.map(r => ({
    "שם תלמיד": r["שם תלמיד"],
    "חדר": r["חדר"],
    "שעת התחלה": r["שעת התחלה"],
    "שעת סיום": r["שעת סיום"]
  })));
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "שיבוץ");
  XLSX.writeFile(wb, "שיבוץ_תלמידים.xlsx");
}
</script>

</body>
</html>
