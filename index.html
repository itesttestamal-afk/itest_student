<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<title>Itest - חלוקת תלמידים</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body { font-family: Arial; direction: rtl; padding: 20px; background: #f9f9f9; }
h1 { text-align: center; margin-bottom: 20px; }
h2 { margin-top: 30px; }
table { border-collapse: collapse; width: 100%; margin-top: 10px; }
th, td { border: 1px solid #444; padding: 6px; text-align: center; }
th { background: #eee; }
button { padding: 10px; margin-top: 10px; margin-right: 10px; }
.room-0 { background-color: #ffdede; }  /* עוז */
.room-1 { background-color: #deffde; }  /* סיבם תיבם */
.room-2 { background-color: #dedeff; }  /* Itest */
.room-3 { background-color: #fff5de; }  /* משאבים */
</style>
</head>

<body>

<h1>Itest - חלוקת תלמידים</h1>

<input type="file" id="excelFile" accept=".xlsx,.xls"><br><br>

<label>שעת התחלת הבחינה:</label>
<input type="time" id="startTime" value="09:00"><br><br>

<button onclick="processFile()">בצע שיבוץ</button>
<button onclick="downloadExcel()" id="downloadBtn" style="display:none">
הורדת קובץ Excel
</button>
<button onclick="downloadMDF()" id="downloadMDFBtn" style="display:none">
הורדת קובץ MDF
</button>

<div id="result"></div>

<script>
const EXAM_DURATION = 30; // דקות
const ROOMS = [
  {name:"עוז", computers:6},
  {name:"סיבם תיבם", computers:5},
  {name:"Itest", computers:5},
  {name:"משאבים", computers:4}
];

let finalData = [];

function processFile() {
  const fileInput = document.getElementById("excelFile");
  if (!fileInput.files.length) { alert("נא להעלות קובץ Excel"); return; }

  const reader = new FileReader();
  reader.onload = e => {
    const data = new Uint8Array(e.target.result);
    const wb = XLSX.read(data, { type: "array" });
    const sheet = wb.Sheets[wb.SheetNames[0]];

    // نقرأ الملف باستخدام الصف الأول كعناوين الأعمدة
    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
    const headers = rows[0]; // الصف الأول كعناوين
    const students = rows.slice(1).map(r => {
      return {
        "שם תלמיד": r[0] || "",
        "כתה": r[1] || ""
      };
    });

    distribute(students);
  };
  reader.readAsArrayBuffer(fileInput.files[0]);
}

function distribute(students) {
  const startTime = document.getElementById("startTime").value;
  finalData = [];

  let roomSlots = ROOMS.map(r => ({timeIndex:0, studentsCount:0}));
  let studentIndex = 0;

  while(studentIndex < students.length) {
    ROOMS.forEach((room, idx) => {
      for(let i=0; i<room.computers && studentIndex<students.length; i++, studentIndex++){
        let slot = roomSlots[idx].timeIndex;
        let start = addMinutes(startTime, slot*EXAM_DURATION);
        let end = addMinutes(start, EXAM_DURATION);
        finalData.push({
          "שם תלמיד": students[studentIndex]["שם תלמיד"],
          "כתה": students[studentIndex]["כתה"] || "",
          "חדר": room.name,
          "שעת התחלה": start,
          "שעת סיום": end,
          "roomClass": "room-" + idx
        });
        roomSlots[idx].studentsCount++;
      }
      if(roomSlots[idx].studentsCount >= room.computers){
        roomSlots[idx].timeIndex++;
        roomSlots[idx].studentsCount = 0;
      }
    });
  }

  showTablesByRoom();
  document.getElementById("downloadBtn").style.display = "inline-block";
  document.getElementById("downloadMDFBtn").style.display = "inline-block";
}

function addMinutes(time, mins) {
  let [h,m] = time.split(":").map(Number);
  let total = h*60 + m + mins;
  let nh = Math.floor(total/60) % 24;
  let nm = total % 60;
  return `${String(nh).padStart(2,"0")}:${String(nm).padStart(2,"0")}`;
}

function showTablesByRoom() {
  let html = "";
  ROOMS.forEach((room, idx) => {
    html += `<h2>${room.name}</h2>`;
    html += `<table>
               <tr>
                 <th>שם תלמיד</th>
                 <th>כתה</th>
                 <th>שעת התחלה</th>
                 <th>שעת סיום</th>
               </tr>`;
    finalData.filter(r => r["חדר"] === room.name).forEach(r => {
      html += `<tr class="room-${idx}">
        <td>${r["שם תלמיד"]}</td>
        <td>${r["כתה"] || ""}</td>
        <td>${r["שעת התחלה"]}</td>
        <td>${r["שעת סיום"]}</td>
      </tr>`;
    });
    html += `</table>`;
  });
  document.getElementById("result").innerHTML = html;
}

function downloadExcel() {
  const wb = XLSX.utils.book_new();
  ROOMS.forEach((room, idx) => {
    const roomData = finalData
      .filter(r => r["חדר"] === room.name)
      .map(r => ({
        "שם תלמיד": r["שם תלמיד"],
        "כתה": r["כתה"] || "",
        "שעת התחלה": r["שעת התחלה"],
        "שעת סיום": r["שעת סיום"]
      }));
    const ws = XLSX.utils.json_to_sheet(roomData);
    XLSX.utils.book_append_sheet(wb, ws, room.name);
  });
  XLSX.writeFile(wb, "שיבוץ_תלמידים.xlsx");
}

function downloadMDF() {
  const mdfContent = finalData.map(r =>
    `${r["שם תלמיד"]};${r["כתה"]};${r["חדר"]};${r["שעת התחלה"]};${r["שעת סיום"]}`
  ).join("\n");

  const blob = new Blob([mdfContent], {type: "text/plain"});
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "שיבוץ_תלמידים.mdf";
  link.click();
}
</script>

</body>
</html>
