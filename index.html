<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>iTest</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: Arial; text-align: center; background: #f4f6f8; padding: 20px; }
h1 { color: #006400; font-size: 42px; margin-bottom: 10px; }
h2 { font-size: 28px; margin-bottom: 20px; color: #333; }
input { width: 80%; max-width: 400px; padding: 12px; font-size: 18px; border: 2px solid #006400; border-radius: 8px; margin-bottom: 20px; }
button { padding: 10px 20px; font-size: 16px; border: none; border-radius: 8px; background: #006400; color: #fff; cursor: pointer; margin-bottom: 20px; }
table { width: 95%; margin: auto; border-collapse: collapse; background: #fff; }
th, td { border: 1px solid #ccc; padding: 10px; font-size: 16px; }
th { background: #e8f5e9; }
</style>
</head>
<body>

<h1>iTest</h1>
<h2 id="examName"></h2>

<input type="text" id="search" placeholder="ابحث عن طالب...">
<br>
<button id="downloadBtn">تحميل Excel</button>

<table id="studentsTable">
  <thead>
    <tr>
      <th>العمود 1</th>
      <th>العمود 2</th>
      <th>العمود 3</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- CSV + Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// ===== Firebase =====
firebase.initializeApp({
  apiKey: "AIzaSyDwo_m6yDM5WAHfUOSbscMgYBOe0OLIdU4",
  authDomain: "itestlogs.firebaseapp.com",
  databaseURL: "https://itestlogs-default-rtdb.firebaseio.com",
  projectId: "itestlogs",
  storageBucket: "itestlogs.firebasestorage.app",
  messagingSenderId: "551369243108",
  appId: "1:551369243108:web:d675894ba6ed4a161f6ff1"
});
const db = firebase.database();

// ===== اسم الطالب إجباري =====
let userName = "";
while(!userName){
  userName = prompt("اكتب اسمك:");
  if(!userName) alert("يجب إدخال الاسم");
}

// سجل الدخول
db.ref("logs").push({
  name: userName,
  action: "فتح الموقع",
  time: new Date().toLocaleString("ar-EG")
});

// ===== CSV Google Sheet =====
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQpvziG2pi3c-qHGIJuP2M5RxUXgkWtK_5I1oPxSRhcp8ml7Ty8b4JVP-OogglSp1ddcYh7WSsUvABV/pub?output=csv";
let studentsData = [];

Papa.parse(csvUrl, {
  download: true,
  complete: function(results){
    const rows = results.data.filter(r => r.length >= 3 && r[0] !== "");
    document.getElementById("examName").textContent = rows[0][0]; // اسم الامتحان من A1
    studentsData = rows.slice(1); // باقي الطلاب
    renderTable(studentsData);
  }
});

function renderTable(data){
  const tbody = document.querySelector("#studentsTable tbody");
  tbody.innerHTML = "";
  data.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td>`;
    tbody.appendChild(tr);
  });
}

// البحث
document.getElementById("search").addEventListener("input", function(){
  const q = this.value.toLowerCase();
  renderTable(studentsData.filter(r=>r.join(" ").toLowerCase().includes(q)));
});

// تحميل Excel
document.getElementById("downloadBtn").onclick = ()=>{
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet([["العمود 1","العمود 2","العمود 3"], ...studentsData]);
  XLSX.utils.book_append_sheet(wb, ws, "Students");
  XLSX.writeFile(wb,"students.xlsx");

  db.ref("logs").push({
    name: userName,
    action: "تحميل Excel",
    time: new Date().toLocaleString("ar-EG")
  });
};
</script>

</body>
</html>
